name: Auto create sub-issues from approved plan

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  create-subissues:
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.issue.labels.*.name, 'epic') &&
      contains(github.event.comment.body, '/approve-subissues') &&
      contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association)
    runs-on: ubuntu-latest
    steps:
      - name: Create sub-issues and link them as sub-issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PARENT_NUMBER: ${{ github.event.issue.number }}
          PARENT_TITLE: ${{ github.event.issue.title }}
          APPROVER: ${{ github.event.comment.user.login }}
        run: |
          set -euo pipefail

          if gh api "repos/$REPO/issues/$PARENT_NUMBER/comments" --jq '.[].body' | grep -q '\[subissues-generated\]'; then
            echo "Already generated. Exit."
            exit 0
          fi

          plan_body="$(
            gh api "repos/$REPO/issues/$PARENT_NUMBER/comments" \
              --jq '[ .[] | select(.body|contains("<!-- subissue-plan-generated:v1 -->")) ] | last | .body // empty'
          )"

          if [ -z "$plan_body" ]; then
            gh api -X POST "repos/$REPO/issues/$PARENT_NUMBER/comments" \
              -f "body=子Issue生成に失敗しました。先に分割案コメント（subissue-plan）を確認してください。" \
              -H "Accept: application/vnd.github+json" >/dev/null
            exit 1
          fi

          printf '%s\n' "$plan_body" | awk '
            found==0 && /^```text$/ {found=1; next}
            found==1 && /^```$/ {exit}
            found==1 {print}
          ' > plan_lines.txt

          if [ ! -s plan_lines.txt ]; then
            gh api -X POST "repos/$REPO/issues/$PARENT_NUMBER/comments" \
              -f "body=子Issue生成に失敗しました。分割案の形式を確認してください（```text 内に1行1タスク）。" \
              -H "Accept: application/vnd.github+json" >/dev/null
            exit 1
          fi

          created_list=""
          created_count=0

          while IFS= read -r line; do
            line="$(echo "$line" | sed 's/^\s*//;s/\s*$//')"
            [ -z "$line" ] && continue

            if ! echo "$line" | grep -q '|'; then
              echo "Skip (invalid format): $line"
              continue
            fi

            kind="$(echo "$line" | cut -d'|' -f1 | sed 's/^\s*//;s/\s*$//')"
            title="$(echo "$line" | cut -d'|' -f2 | sed 's/^\s*//;s/\s*$//')"
            labels_raw="$(echo "$line" | cut -d'|' -f3- | sed 's/^\s*//;s/\s*$//')"

            [ -z "$title" ] && continue

            labels_args=()
            if [ -n "$labels_raw" ]; then
              IFS=',' read -ra arr <<< "$labels_raw"
              for x in "${arr[@]}"; do
                x_trim="$(echo "$x" | sed 's/^\s*//;s/\s*$//')"
                [ -n "$x_trim" ] && labels_args+=(-f "labels[]=$x_trim")
              done
            fi
            if [ -n "$kind" ]; then
              labels_args+=(-f "labels[]=$kind")
            fi

            body="$(printf '%s\n' \
              "親Issue: #$PARENT_NUMBER" \
              "EPIC: $PARENT_TITLE" \
              "" \
              "- 作業開始前に doc/README.md を読むこと" \
              "- .codex/AGENTS.md のルール（ブランチ/PR/DoD）を守ること" \
              "" \
              "## DoD（要約）" \
              "- ローカル: npm run format / lint / typecheck / test" \
              "- PR: CI（format:check/lint/typecheck/test）成功")"

            child_json="$(gh api -X POST "repos/$REPO/issues" \
              -f "title=$title" \
              -f "body=$body" \
              "${labels_args[@]}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28")"

            child_number="$(echo "$child_json" | jq -r '.number')"
            child_id="$(echo "$child_json" | jq -r '.id')"

            gh api -X POST "repos/$REPO/issues/$PARENT_NUMBER/sub_issues" \
              -f "sub_issue_id=$child_id" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" >/dev/null

            created_count=$((created_count + 1))
            created_list="${created_list}- #${child_number} ${title}"$'\n'
            echo "Created and linked #$child_number"
          done < plan_lines.txt

          summary_body="$(printf '%s\n' \
            "[subissues-generated] オーナー（@${APPROVER}）承認により子Issueを自動生成しました。" \
            "" \
            "生成数: ${created_count}" \
            "" \
            "### 生成された子Issue" \
            "${created_list}" \
            "" \
            "### 推奨着手順" \
            "Issue番号の昇順で順に着手してください。")"

          gh api -X POST "repos/$REPO/issues/$PARENT_NUMBER/comments" \
            -f "body=${summary_body}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" >/dev/null
