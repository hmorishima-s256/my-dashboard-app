name: Auto close linked issues on development merge

on:
  pull_request:
    types: [closed]
    branches:
      - development

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  close-linked-issues:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Close issues referenced by close keywords in PR body
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail

          if [ -z "${PR_BODY:-}" ]; then
            echo "PR body is empty. Nothing to close."
            exit 0
          fi

          issue_numbers="$(
            printf '%s\n' "$PR_BODY" \
              | grep -Eio '\b(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#([0-9]+)\b' \
              | grep -Eo '[0-9]+' \
              | sort -u || true
          )"

          if [ -z "$issue_numbers" ]; then
            echo "No close keywords found in PR body."
            exit 0
          fi

          for issue_number in $issue_numbers; do
            issue_json="$(gh api "repos/$REPO/issues/$issue_number" -H "Accept: application/vnd.github+json")"

            if echo "$issue_json" | jq -e '.pull_request != null' >/dev/null; then
              echo "Skip #$issue_number (this is a PR)."
              continue
            fi

            issue_state="$(echo "$issue_json" | jq -r '.state')"
            if [ "$issue_state" = "closed" ]; then
              echo "Issue #$issue_number is already closed."
              continue
            fi

            gh api -X PATCH "repos/$REPO/issues/$issue_number" \
              -f "state=closed" \
              -H "Accept: application/vnd.github+json" >/dev/null

            gh api -X POST "repos/$REPO/issues/$issue_number/comments" \
              -f "body=Closed automatically because PR #$PR_NUMBER was merged into development." \
              -H "Accept: application/vnd.github+json" >/dev/null

            echo "Closed issue #$issue_number"
          done
