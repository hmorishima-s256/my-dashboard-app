# 06. データ保存仕様

## 6.1 保存方針

- 外部DBは使わずローカルファイルのみ
- ユーザー共通とユーザー個別を分離
- ログアウト時は `token.json` のみ削除

### なぜこの方針か

- 単体PC運用を成立させるため
- 認証切替とユーザー設定再利用を両立するため

## 6.2 保存ルート

```txt
C:\Users\<Windowsユーザー名>\my-dashboard-app\
```

- 共通: `C:\Users\...\my-dashboard-app\_shared\`
- ユーザー別: `C:\Users\...\my-dashboard-app\<url-encoded-email>\`

## 6.3 ディレクトリ構成

```txt
my-dashboard-app/
  _shared/
    current-user.json
    settings.guest.json
    electron.svg
    auto-launch-initialized
  <url-encoded-email>/
    token.json
    user-profile.json
    settings.json
    tasks.json
```

## 6.4 共通ファイル

### `current-user.json`

```json
{
  "email": "user@example.com"
}
```

### `settings.guest.json`

- 未ログイン時の設定保存先

### `electron.svg`

- デフォルトプロフィールアイコン
- 無ければ起動時に自動生成

### `auto-launch-initialized`

- Windows自動起動を初回設定済みであることを示すマーカー

## 6.5 ユーザー別ファイル

### `token.json`

- OAuthトークン保存
- `safeStorage` 可能時は暗号化形式
- 非対応時は平文フォールバック

暗号化形式例:

```json
{
  "version": 1,
  "encrypted": true,
  "data": "<base64>"
}
```

### `user-profile.json`

```json
{
  "name": "Taro",
  "email": "user@example.com",
  "iconUrl": "https://..."
}
```

### `settings.json`

```json
{
  "autoFetchTime": "08:30",
  "autoFetchIntervalMinutes": 60,
  "taskTimeDisplayMode": "hourMinute"
}
```

### `tasks.json`

```json
{
  "tasks": [
    {
      "id": "...",
      "userId": "user@example.com",
      "date": "2026-02-19",
      "project": "案件A",
      "category": "設計",
      "title": "実装",
      "status": "doing",
      "priority": "中",
      "memo": "",
      "estimated": {
        "start": "09:30",
        "end": "17:15",
        "minutes": 405
      },
      "actual": {
        "minutes": 180,
        "suspendMinutes": 15,
        "suspendStartedAt": null,
        "logs": [
          {
            "start": "2026-02-19T00:30:00.000Z",
            "end": "2026-02-19T03:30:00.000Z"
          }
        ]
      },
      "createdAt": "...",
      "updatedAt": "..."
    }
  ],
  "projects": ["案件A"],
  "categories": ["設計"]
}
```

注記:
- `projectCategories` / `projectTitles` は `tasks` から動的生成し、ファイルへは保存しない。

## 6.6 正規化ルール

- `autoFetchTime`: `HH:mm` 以外は `null`
- `autoFetchIntervalMinutes`: 1以上の整数以外は `null`
- `taskTimeDisplayMode`: `hourMinute` / `decimal` 以外は既定値
- `Task.actual.minutes`: 0以上整数
- `Task.actual.suspendMinutes`: 0以上整数
- `Task.actual.suspendStartedAt`: 不正日時は `null`

## 6.7 ライフサイクル

- ログイン:
  - `current-user.json` 更新
  - `user-profile.json` 保存
  - `token.json` 保存
- ログアウト:
  - `token.json` のみ削除
- ゲスト:
  - タスクはテンポラリ保存
  - 終了時に削除

## 6.8 互換性方針

- 旧 `tasks.json`（`suspendMinutes` が無い形式）も読込時に正規化して扱う

### なぜ必要か

- 既存ユーザーデータを壊さずに機能追加するため
