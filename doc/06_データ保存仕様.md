# 06. データ保存仕様

## 6.1 保存ポリシー

- 外部 DB は使用しない
- Windows ユーザーホーム配下に保存
- 共通ファイルとユーザー別ファイルを分離
- ログアウト時は `token.json` のみ削除

## 6.2 ルートディレクトリ

```txt
C:\Users\<Windowsユーザー名>\my-dashboard-app\
```

実装定数:

- `APP_LOCAL_ROOT_PATH = path.join(os.homedir(), 'my-dashboard-app')`
- `APP_SHARED_CONFIG_DIR = path.join(APP_LOCAL_ROOT_PATH, '_shared')`

## 6.3 ディレクトリ構成

```txt
my-dashboard-app/
  _shared/
    current-user.json
    settings.guest.json
    electron.svg
    auto-launch-initialized
  <url-encoded-email>/
    token.json
    user-profile.json
    settings.json
    tasks.json
```

## 6.4 共通ファイル

### `current-user.json`

現在アクティブなユーザーポインタ。

```json
{
  "email": "user@example.com"
}
```

### `settings.guest.json`

未ログイン時に利用する設定ファイル。

### `electron.svg`

固定プロフィールアイコンの共通ファイル。存在しない場合は Main 起動時に生成。

### `auto-launch-initialized`

Windows 自動起動設定を初回適用済みであることを示すマーカー。

## 6.5 ユーザー別ファイル

### `token.json`

- OAuth 認証情報
- 形式:
  - 暗号化形式（`safeStorage` 利用可能時）
  - 平文 JSON（フォールバック）
- 読み込み時は両形式を互換対応

暗号化保存時の例:

```json
{
  "version": 1,
  "encrypted": true,
  "data": "<base64>"
}
```

### `user-profile.json`

```json
{
  "name": "Taro",
  "email": "user@example.com",
  "iconUrl": "https://..."
}
```

### `settings.json`

```json
{
  "autoFetchTime": "08:30",
  "autoFetchIntervalMinutes": 60,
  "taskTimeDisplayMode": "hourMinute"
}
```

### `tasks.json`

- `lowdb` で管理するタスク保存ファイル
- 形式:

```json
{
  "tasks": [],
  "projects": [],
  "categories": []
}
```

補足:

- `projectCategories` / `projectTitles` は `task:get-all` 応答時に `tasks` から動的生成するため、ファイルには直接保持しない

## 6.6 設定値正規化

- `autoFetchTime`
  - 許可: `HH:mm`
  - 不正値: `null`
- `autoFetchIntervalMinutes`
  - 許可: 1以上の整数
  - 不正値: `null`
- `taskTimeDisplayMode`
  - 許可: `hourMinute` / `decimal`
  - 不正値: `hourMinute`

## 6.7 ライフサイクル

- ログイン:
  - `current-user.json` 更新
  - `user-profile.json` 更新
  - `token.json` 保存
- ログアウト:
  - `token.json` 削除
  - その他ファイルは保持
- ゲスト利用:
  - セッション用 `lowdb` を利用
  - アプリ終了時に削除

## 6.8 運用上の注意

- `credentials.json` はプロジェクトルートに配置が必要
- 暗号化フォールバック時の `token.json` は OS 権限管理が必要
