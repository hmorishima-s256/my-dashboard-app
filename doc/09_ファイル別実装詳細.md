# 09. ファイル別実装詳細

## 9.1 Main Process

### `src/main/index.ts`

- アプリ起動初期化
  - `ensureSharedFiles()`
  - `getSavedUserProfile()`
  - `loadAppSettings(currentUser)`
  - `applyWindowsAutoLaunchSetting()`
  - `createTray()`
  - `startAutoFetchScheduler()`
- 予定取得
  - `fetchAndNotifyEventsByDate(targetDate, source)`
- 自動取得
  - `runAutoFetchIfNeeded()`
  - `startAutoFetchScheduler()`
- 終了制御
  - `quitApplication()`
  - close 時ダイアログ分岐（常駐/終了）
- IPC
  - `get-calendar`
  - `get-settings`
  - `save-settings`
  - `get-default-profile-icon-url`
  - `auth:get-current-user`
  - `auth:login`
  - `auth:logout`

### `src/main/googleAuth.ts`

- OAuth 設定読み込み
  - `loadOAuthClientConfig()`
- ブラウザ認証
  - `authorizeWithBrowser()`
- ユーザー情報取得
  - `fetchUserProfile()`
- 保存系
  - `saveCurrentUserPointer()`
  - `saveCredentials()`
  - `saveUserProfile()`
- 復元系
  - `loadSavedCredentialsIfExist()`
  - `getSavedUserProfile()`
- 認証API
  - `loginWithGoogle()`
  - `logoutGoogle()`
- カレンダー取得
  - `getEventsByDate(targetDate)`
  - `getTodayEvents()`
- 共有ファイル
  - `ensureSharedFiles()`
  - `getDefaultProfileIconUrl()`

### `src/main/appSettings.ts`

- 設定型: `AppSettings`
- 設定パス選択
  - 未ログイン: `_shared/settings.guest.json`
  - ログイン済み: `<user>/settings.json`
- 正規化
  - `normalizeAutoFetchTime()`
  - `normalizeAutoFetchIntervalMinutes()`
- API
  - `loadAppSettings(currentUser)`
  - `saveAppSettings(currentUser, settings)`

## 9.2 Preload

### `src/preload/index.ts`

- `contextBridge.exposeInMainWorld('api', api)`
- Renderer 公開 API の定義

### `src/preload/index.d.ts`

- `window.api` 型定義
- IPC 入出力の型を一元化

## 9.3 Renderer

### `src/renderer/src/App.tsx`

- 画面全体 state 管理
- 起動時初期化
  - 現在ユーザー取得
  - 設定読込
  - 更新通知購読
- 予定同期
  - 手動同期
  - 日付変更による再取得
- 日付入力パネル
  - 数字正規化
  - 0補完
  - エラー表示
  - Enter/OK/キャンセル制御
- 認証 UI
  - ログイン
  - プロフィールメニュー
  - ログアウト確認モーダル
- 設定 UI
  - 時刻・間隔の編集/保存/未設定化

### `src/renderer/src/assets/main.css`

- ダッシュボードテーマ（黒 + 緑アクセント）
- 上部 3 カラムレイアウト
- 日付入力パネルスタイル
- タブ/テーブル/タスクカードスタイル
- モーダルスタイル
- レスポンシブ調整

### `src/renderer/src/main.tsx`

- `App` のマウントエントリ

### `src/renderer/index.html`

- ルート要素 `#root`
- CSP 設定

## 9.4 ビルド/配布設定

### `package.json`

- 開発/ビルド/型チェックスクリプト
- Electron/React/Google API 依存定義

### `electron-builder.yml`

- `appId`, `productName`
- Windows/macOS/Linux のターゲット設定
- `asarUnpack` 設定
- インストーラ名設定（NSIS）
