# 03. 機能仕様

## 3.1 Google認証

### 仕様

- ログインUI: 右上 `Googleログイン`
- IPC: `auth:login`
- 取得スコープ:
  - `calendar.readonly`
  - `openid`
  - `userinfo.email`
  - `userinfo.profile`
- ログイン成功時:
  - 現在ユーザー更新
  - ユーザー別設定読込
  - 当日予定を手動同期として取得
  - アプリ画面を前面化
- ログアウトUI:
  - 右上アイコンメニュー -> `ログアウト`
- IPC: `auth:logout`
- ログアウト成功時:
  - `token.json` のみ削除
  - ユーザー状態を未ログインへ
  - 予定を空配信
  - ゲスト設定へ切替

### なぜこの仕様か

- `token.json` だけ削除する理由:
  - 再ログイン時にユーザー設定や履歴（`tasks.json`）を再利用できるようにするため
- ログイン直後に当日同期する理由:
  - ログイン成功後の画面を即時に利用可能な状態へ揃えるため

## 3.2 予定取得

### 仕様

- 手動同期UI: 右上 `同期`
- IPC: `get-calendar(targetDate?)`
- 未ログイン時は同期ボタン無効
- 取得対象:
  - `calendarList` で取得した全カレンダー
  - 指定日の 00:00:00 - 23:59:59
- 取得方式:
  - カレンダー単位で並列取得（同時実行上限あり）
  - 429/5xx/通信系は指数バックオフでリトライ
- 表示整形:
  - 日時列: 終日 `1day`、時刻予定は `HH:mm` の開始/終了2行
  - カレンダー名: メール形式は `@` 前を表示

### なぜこの仕様か

- 全カレンダー対象にした理由:
  - 実運用でサブカレンダーを含めて確認するケースが多いため
- 2行表示にした理由:
  - 開始・終了を同時に視認でき、1セルで把握しやすいため

## 3.3 日付指定

### 仕様

- ヘッダー表示: `yyyy/mm/dd(曜)`
- 日付ボタン押下で入力パネルを開閉
- 右側シェブロン:
  - 左 `◀`: 前日
  - 右 `▶`: 翌日
- 入力欄: `yyyy` / `mm` / `dd`
- 入力制御:
  - 全角数字を半角化
  - 数字以外を除去
  - 桁不足は0補完
  - 年4桁入力後に月、月2桁入力後に日へ自動フォーカス
- `dd` で Enter は OK と同等
- バリデーション:
  - 桁不足、月日範囲、存在しない日付
- 閉じる操作:
  - キャンセル
  - Esc
  - 日付ボタン再押下

### なぜこの仕様か

- シェブロンで前後日移動を入れた理由:
  - 日次確認をキーボード・マウス少操作で連続実行できるため
- `yyyy/mm/dd(曜)` にした理由:
  - 日本語業務で曜日認知を即時に行うため

## 3.4 タブ構成

### 仕様

- タブ1: `予定表`
- タブ2: `タスク`

### なぜこの仕様か

- 予定とタスクを同一画面で切り替える理由:
  - コンテキストを維持したまま確認・更新できるため

## 3.5 タスク管理（予実）

### 仕様

- データ保存: `lowdb`（ユーザー別 `tasks.json`）
- 入力:
  - 案件/カテゴリ/タスクは creatable select
  - カテゴリ候補は「選択案件に紐づくカテゴリ」
  - タスク候補は「選択案件に紐づくタスク」
- 登録/詳細モーダル:
  - 予定グループ（開始予定/終了予定/見積時間）
  - 実績グループ（開始時間/終了時間/中断時間/実績時間）
- 実績入力ルール:
  - 開始のみ入力可（終了は空で可）
  - 終了のみ入力は不可
- 状態操作:
  - `開始` -> `doing`
  - `中断` -> `suspend`
  - `再開` -> `doing`
  - `停止` -> `finished`
  - `完了` -> `done`
- 実績計算:
  - 基本は分で保持
  - 開始/終了から算出時は「昼休憩(12:00-13:00) + 中断時間」を控除
- 表示単位:
  - `6時間45分` または `6.75時間`（設定で切替）

### なぜこの仕様か

- 内部保持を分に固定した理由:
  - 小数時間の丸め誤差を回避し、一貫した計算を保つため
- 中断時間を独立データ化した理由:
  - 実績計算時に休止時間を明確に控除できるため
- `再開` ボタンを状態連動にした理由:
  - 操作対象を現在状態に合わせ、誤操作を減らすため

## 3.6 設定

### 仕様

- モーダル起動: 左下歯車
- 項目:
  - 自動取得時刻
  - 自動取得間隔（分/時間入力、保存は分）
  - タスク時間表記モード
- ボタン:
  - `閉じる` / `未設定にする` / `保存`
- 反映タイミング:
  - 保存時のみ反映

### なぜこの仕様か

- 即時反映ではなく保存反映にした理由:
  - 操作途中の意図しない設定変更を防ぐため

## 3.7 自動取得

### 仕様

- 判定周期: 30秒
- 実行条件（OR）:
  - 指定時刻到達（1日1回）
  - 指定間隔経過
- 未ログイン時は実行しない

### なぜこの仕様か

- 30秒ポーリングにした理由:
  - 高精度スケジューラより実装と運用を単純にしつつ、実用上十分なため

## 3.8 バックグラウンド常駐

### 仕様

- ウィンドウクローズ時に確認ダイアログ
  - `バックグラウンド常駐`
  - `終了`
- 常駐時はトレイへ格納
- 終了時はスケジューラ停止・トレイ破棄・終了

### なぜこの仕様か

- クローズ時確認を入れた理由:
  - 「閉じる=終了」と「閉じる=常駐」の利用者差を吸収するため

## 3.9 Windows自動起動

### 仕様

- 対象: `win32` かつ `app.isPackaged`
- 初回1回のみ `openAtLogin` 設定
- マーカー: `_shared/auto-launch-initialized`
- 起動引数: `--hidden`

### なぜこの仕様か

- 初回1回だけ設定する理由:
  - 動作確認中の再起動ループを避け、予期しない自動起動を防ぐため
