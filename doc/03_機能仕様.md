# 03. 機能仕様

## 3.1 Google 認証

### ログイン

- UI: 右上 `Googleログイン`
- API: `auth:login`
- スコープ:
  - `https://www.googleapis.com/auth/calendar.readonly`
  - `openid`
  - `https://www.googleapis.com/auth/userinfo.email`
  - `https://www.googleapis.com/auth/userinfo.profile`
- 成功時:
  - プロフィール保存
  - 現在ユーザーを切替
  - ユーザー設定を再読込
  - 当日予定を自動同期
  - メインウィンドウを前面表示

### ログアウト

- UI: 右上プロフィールメニュー -> `ログアウト`
- API: `auth:logout`
- 動作:
  - `token.json` のみ削除
  - `currentUser` を null 化
  - 予定一覧をクリア
  - 設定をゲスト設定へ切替

## 3.2 予定取得

### 手動同期

- UI: 右上 `同期`
- API: `get-calendar(targetDate?)`
- 未ログイン時はボタン disabled

### 取得対象

- `calendarList` にある登録済み全カレンダー
- 指定日の 00:00:00 - 23:59:59 を対象
- カレンダー単位の取得は並列実行（同時実行上限あり）
- 一時障害はリトライ
  - 対象: 429, 5xx, ネットワーク系
  - 方式: 指数バックオフ

### 一覧整形

- 列順: `日時` / `件名` / `カレンダー名`
- カレンダー名:
  - `summaryOverride` -> `summary` -> `id`
  - メール形式の場合は `@` 以前を表示
- 件名:
  - 未設定は `(no title)`
- 日時:
  - 終日予定は `1day`
  - 時刻予定は JST `HH:mm` を開始/終了の2行で表示

## 3.3 日付指定

- ヘッダー左の日付を押下すると入力パネルを開閉
- 入力欄:
  - `yyyy` (4桁)
  - `mm` (2桁)
  - `dd` (2桁)
- 入力制御:
  - 全角数字は半角へ自動変換
  - 数字以外は除去
  - 桁不足は blur 時や確定時に 0 補完
  - `yyyy` 入力完了で `mm` へ自動フォーカス
  - `mm` 入力完了で `dd` へ自動フォーカス
  - `dd` で Enter は `OK` と同等
- バリデーション:
  - 桁不足
  - 月範囲外
  - 日範囲外
  - 実在しない日付
- エラー表示:
  - 対象フィールド赤枠
  - インラインエラーメッセージ
- 閉じる操作:
  - `キャンセル`
  - `Esc`
  - 日付ボタン再押下

## 3.4 タブ表示

- `予定表` タブ:
  - Google Calendar 取得結果を表示
- `タスク` タブ:
  - 選択日のタスク一覧を表示
  - タスク登録フォームで案件/カテゴリ/タスクを登録
  - 案件/カテゴリは候補選択 + 新規作成（creatable select）
  - 見積時刻（開始/終了/分）を相互補完
  - `開始` で doing + 実績ログ開始
  - `中断` で suspend + 実績分加算
  - `停止` で finished + 実績分加算
  - `完了` で done + 実績分加算
  - ステータスで行色を変更

## 3.5 設定機能

- 起動: 左下歯車ボタン
- 設定項目:
  - 自動取得時刻 (`HH:mm` or 未設定)
  - 自動取得間隔（保存は分、UIは分/時間切替）
- ボタン:
  - `閉じる`
  - `未設定にする`
  - `保存`
- 閉じる操作:
  - 背景クリック
  - `閉じる`
  - `Esc`

## 3.6 自動取得スケジューラ

- 判定周期: 30秒
- 実行条件:
  - 指定時刻一致かつ当日未実行
  - 指定間隔経過
- 両方設定時は OR 条件
- 起動時/設定変更時に判定状態をリセット

## 3.7 バックグラウンド常駐

- ウィンドウ close 時にダイアログ表示
  - `バックグラウンド常駐`
  - `終了`
- 常駐:
  - ウィンドウを非表示
  - Tray から再表示可能
- 終了:
  - スケジューラ停止
  - Tray 破棄
  - アプリ終了

## 3.8 Windows 自動起動

- 対象: `win32` かつ `app.isPackaged === true`
- 初回1回のみ `openAtLogin: true` を設定
- 再実行防止: `_shared/auto-launch-initialized`
- 自動起動引数: `--hidden`

## 3.9 更新通知

- チャネル: `calendar-updated`
- 送信タイミング:
  - 手動同期後
  - 自動取得後
  - ログアウト後のクリア通知
- Renderer 側挙動:
  - 表示日が今日以外の場合、`source: 'auto'` 通知は無視

## 3.10 タスク永続化

- 保存エンジン: `lowdb`
- ログイン中:
  - `<userDir>/tasks.json` に永続保存
- 未ログイン（ゲスト）:
  - ゲストセッション用 DB を使用
  - アプリ終了時に削除（次回起動へ持ち越さない）
