# 10. テスト仕様

## 10.1 目的

- 主要なドメインロジックの回帰を検知する
- リファクタリング時の安全網を確保する
- Main/Renderer の境界契約（IPC）を崩さない

## 10.2 使用ツール

- テストランナー: `vitest`
- 実行スクリプト:
  - `npm run test`（単発実行）
  - `npm run test:watch`（監視実行）

## 10.3 テスト対象（現時点）

### Renderer ユーティリティ

- `tests/renderer/dateUtils.test.ts`
  - 日付整形
  - 日時整形
  - 全角数字正規化
  - 0埋め処理
- `tests/renderer/settingsUtils.test.ts`
  - 分/時間の相互変換
  - 不正入力の null 化
- `tests/renderer/taskTimeUtils.test.ts`
  - 見積時刻計算
  - 実績分計算（秒切り捨て）
  - 開始/停止時のログ更新

### Main サービス

- `tests/main/autoFetchScheduler.test.ts`
  - 未ログイン時の非実行
  - 指定時刻トリガー
  - 指定間隔トリガー
  - 実行状態リセット
- `tests/main/calendarPublisher.test.ts`
  - 未ログイン時の空返却
  - 取得成功時の `calendar-updated` 通知
  - 取得失敗時の例外吸収
  - 空配信処理
- `tests/main/appSettings.test.ts`
  - デフォルト読込
  - ゲスト保存
  - ユーザー別保存
  - 正規化処理
- `tests/main/registerMainIpcHandlers.test.ts`
  - 合成関数が機能別ハンドラへ委譲することを検証
- `tests/main/ipc/calendarHandlers.test.ts`
  - `get-calendar` の登録と日付フォールバック
- `tests/main/ipc/settingsHandlers.test.ts`
  - `get-settings` / `save-settings` / `get-default-profile-icon-url`
- `tests/main/ipc/taskHandlers.test.ts`
  - `task:get-all` フォールバック
  - `task:add/update/delete` の委譲
- `tests/main/ipc/authHandlers.test.ts`
  - `auth:login` 成功/失敗
  - `auth:logout` 成功/失敗
- `tests/main/taskStore.test.ts`
  - タスク追加/取得
  - タスク更新/削除
  - ゲストデータクリア

## 10.4 実行結果の基準

- すべてのテストファイルが `passed`
- 追加変更時は `npm run typecheck` も合わせて通過させる
- 現在の基準: `12 test files / 44 tests` が通過

## 10.5 実行手順

```bash
npm install
npm run test
npm run typecheck
```

## 10.6 テスト追加ルール

- 純粋関数はユニットテストを優先
- I/O を含む処理は依存注入またはモックで分離
- IPC は「登録」と「ハンドラ副作用」を分けて検証
- 1テスト1責務を基本にする

## 10.7 現在の未カバー領域

- `googleAuth.ts` の OAuth コールバックサーバー実動作
- BrowserWindow/Tray を含む統合挙動
- Renderer コンポーネント単位の UI テスト

これらは E2E または統合テスト基盤導入時に拡張予定。
